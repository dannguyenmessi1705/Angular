# L√†m vi·ªác v·ªõi Form trong Angular
## 1. Gi·ªõi thi·ªáu
Angular cung c·∫•p hai c√°ch ƒë·ªÉ l√†m vi·ªác v·ªõi form: Template-driven v√† Reactive.
- `Template-driven form` l√† c√°ch ti·∫øp c·∫≠n ƒë∆°n gi·∫£n, d·ªÖ s·ª≠ d·ª•ng cho c√°c form nh·ªè.
- `Reactive form` cung c·∫•p nhi·ªÅu t√≠nh nƒÉng m·∫°nh m·∫Ω h∆°n, ph√π h·ª£p cho c√°c form ph·ª©c t·∫°p.

## 2. So s√°nh
| Ti√™u ch√≠         | Template-driven form                | Reactive form                       |
|------------------|-------------------------------------|-------------------------------------|
| C√°ch ti·∫øp c·∫≠n    | D·ª±a tr√™n template                   | D·ª±a tr√™n m√£ ngu·ªìn                   |
| Qu·∫£n l√Ω tr·∫°ng th√°i| T·ª± ƒë·ªông, th√¥ng qua ng·ªØ c·∫£nh       | Th·ªß c√¥ng, th√¥ng qua FormGroup     |
| T√≠nh linh ho·∫°t    | √çt linh ho·∫°t h∆°n                    | R·∫•t linh ho·∫°t                       |
| Ki·ªÉm tra h·ª£p l·ªá   | D·ªÖ d√†ng, nh∆∞ng h·∫°n ch·∫ø              | Ph·ª©c t·∫°p h∆°n, nh∆∞ng m·∫°nh m·∫Ω h∆°n    |
| T√≠nh m·ªü r·ªông      | Kh√≥ m·ªü r·ªông cho c√°c form ph·ª©c t·∫°p  | D·ªÖ d√†ng m·ªü r·ªông                     |

## 3. Template-driven Form
- L√†m vi·ªác v·ªõi template-driven form trong Angular r·∫•t ƒë∆°n gi·∫£n. B·∫°n ch·ªâ c·∫ßn s·ª≠ d·ª•ng c√°c directive nh∆∞ `ngModel` ƒë·ªÉ li√™n k·∫øt d·ªØ li·ªáu gi·ªØa form v√† component.
- V√≠ d·ª•:
```html
<form #myForm="ngForm" (ngSubmit)="onSubmit(myForm)"> <!-- L·∫•y tham chi·∫øu ƒë·∫øn form v√† x·ª≠ l√Ω s·ª± ki·ªán submit -->
  <input type="text" name="username" ngModel required> <!-- Li√™n k·∫øt d·ªØ li·ªáu 2 chi·ªÅu gi·ªØa input v√† component -->
  <button [disabled]="myForm.invalid">Submit</button>
</form>
```
```ts
import { Component } from '@angular/core';
import { NgForm, FormModules } from '@angular/forms';

@Component({
  selector: 'app-template-driven-form',
  templateUrl: './template-driven-form.component.html',
  providers: [FormsModule]
})
export class TemplateDrivenFormComponent {
  onSubmit(formModal: NgForm) {
    console.log(formModal.form.value); // { username: '...' }
  }
}
```

> L∆∞u √Ω khi s·ª≠ d·ª•ng `ngModel`: 
- Ch·ªâ s·ª≠ d·ª•ng trong c√°c form template-driven, kh√¥ng s·ª≠ d·ª•ng trong reactive form.
- `ngForm` gi√∫p qu·∫£n l√Ω tr·∫°ng th√°i c·ªßa form v√† cung c·∫•p th√¥ng tin v·ªÅ t√≠nh h·ª£p l·ªá c·ªßa form.
- Khi s·ª≠ d·ª•ng `ngModel`, `ngSubmit` c·∫ßn import th√™m `FormsModule` trong module ch·ª©a component.
- `ngModel` ch·ªâ h·ªó tr·ª£ trong c√°c th·∫ª `<input>`, `<select>`, v√† `<textarea>`, v√† mu·ªën li√™n k·∫øt ƒë∆∞·ª£c c·∫ßn th√™m thu·ªôc t√≠nh `name` v√†o c√°c th·∫ª n√†y. Gi√° tr·ªã c·ªßa `ngModel` s·∫Ω ƒë∆∞·ª£c ƒë·ªìng b·ªô h√≥a v·ªõi gi√° tr·ªã c·ªßa input.
- C√≥ th·ªÉ kh√¥ng c·∫ßn s·ª≠ d·ª•ng `ngForm`, ch·ªâ s·ª≠ d·ª•ng `ngModel` v·ªõi √Ω nghƒ©a t·∫°o ra li√™n k·∫øt 2 chi·ªÅu gi·ªØa input v√† component. `[(ngModel)]` l√† c√∫ ph√°p vi·∫øt t·∫Øt c·ªßa `ngModel` v√† `ngModelChange`, gi√∫p ƒë·ªìng b·ªô h√≥a gi√° tr·ªã gi·ªØa input v√† component. Gi√° tr·ªã c·ªßa thu·ªôc t√≠nh `name` c≈©ng ch√≠nh l√† bi·∫øn trong component.

### 3.1. Validate form
- ƒê·ªëi v·ªõi template-driven form, Angular cung c·∫•p c√°c directive ƒë·ªÉ ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa form nh∆∞ `required`, `minlength`, `maxlength`, `pattern`, v.v. b·∫±ng c√°ch th√™m c√°c thu·ªôc t√≠nh n√†y v√†o c√°c th·∫ª `<input>`, `<select>`, v√† `<textarea>`.
- C√πng v·ªõi ƒë√≥, Angular c≈©ng cung c·∫•p c√°c class CSS ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i h·ª£p l·ªá c·ªßa form nh∆∞ (ch√∫ng ta s·ª≠ d·ª•ng c√°c class n√†y ƒë·ªÉ style css):
  - `ng-valid` - tr·∫°ng th√°i h·ª£p l·ªá
  - `ng-invalid` - tr·∫°ng th√°i kh√¥ng h·ª£p l·ªá
  - `ng-pristine` - tr·∫°ng th√°i ch∆∞a thay ƒë·ªïi (ng∆∞·ªùi d√πng ch∆∞a nh·∫≠p g√¨)
  - `ng-dirty` - tr·∫°ng th√°i ƒë√£ thay ƒë·ªïi.
  - `ng-touched` - tr·∫°ng th√°i ƒë√£ ƒë∆∞·ª£c ng∆∞·ªùi d√πng t∆∞∆°ng t√°c (focus v√† blur).
  - `ng-submitted` - tr·∫°ng th√°i ƒë√£ ƒë∆∞·ª£c g·ª≠i (submit).
  - `ng-untouched` - tr·∫°ng th√°i ch∆∞a ƒë∆∞·ª£c ng∆∞·ªùi d√πng t∆∞∆°ng t√°c.

- K·∫øt h·ª£p v·ªõi c√°c class n√†y, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng c√°c thu·ªôc t√≠nh nh∆∞ `.valid`, `.invalid`, `.pristine`, `.dirty`, `.touched`, `.untouched`, v√† `.submitted` ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i c·ªßa form trong component, b·∫±ng c√°ch tham chi·∫øu ƒë·∫øn c√°c bi·∫øn template n√†y g√°n v·ªõi `ngModel`

```html
<form #myForm="ngForm" (ngSubmit)="onSubmit(myForm)">
  <input type="email" name="email" ngModel required #email="ngModel">
  <input type="password" name="password" ngModel required minlength="6" #password="ngModel">
  <button [disabled]="myForm.invalid">Submit</button>
</form>

@ if (email.touched && email.dirty && email.invalid) { // N·∫øu tr∆∞·ªùng email ƒë√£ ƒë∆∞·ª£c ng∆∞·ªùi d√πng t∆∞∆°ng t√°c v√† thay ƒë·ªïi, v√† kh√¥ng h·ª£p l·ªá
  // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói cho email
  <p>Email kh√¥ng h·ª£p l·ªá</p>
}

@ if (password.touched && password.dirty && password.invalid) { // N·∫øu tr∆∞·ªùng password ƒë√£ ƒë∆∞·ª£c ng∆∞·ªùi d√πng t∆∞∆°ng t√°c v√† thay ƒë·ªïi, v√† kh√¥ng h·ª£p l·ªá
  // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói cho password
  <p>Password kh√¥ng h·ª£p l·ªá</p>
}
```

### 3.2. L·∫Øng nghe thay ƒë·ªïi
- ƒê·ªÉ l·∫Øng nghe c√°c thay ƒë·ªïi trong form, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng thu·ªôc t√≠nh `valueChanges` c·ªßa `NgForm` ho·∫∑c `FormGroup`.
- `valueChanges` s·∫Ω tr·∫£ ra 1 observable, cho ph√©p b·∫°n theo d√µi c√°c thay ƒë·ªïi trong gi√° tr·ªã c·ªßa form, k·∫øt h·ª£p v·ªõi `debounceTime` ƒë·ªÉ gi·∫£m thi·ªÉu s·ªë l·∫ßn ph√°t ra gi√° 
tr·ªã m·ªõi.
- Th√™m v√†o ƒë√≥ s·ª≠ d·ª•ng `afterNextRender` ƒë·ªÉ ƒë·∫£m b·∫£o r·∫±ng form ƒë√£ ƒë∆∞·ª£c render tr∆∞·ªõc khi l·∫Øng nghe c√°c thay ƒë·ªïi.
- V√≠ d·ª•:
```ts
import {
  afterNextRender,
  Component,
  DestroyRef,
  inject,
  viewChild,
} from "@angular/core";
import { FormsModule, NgForm } from "@angular/forms";
import { debounceTime } from "rxjs";

@Component({
  selector: "app-login",
  standalone: true,
  templateUrl: "./login.component.html",
  styleUrl: "./login.component.css",
  imports: [FormsModule],
})
export class LoginComponent {
  formView = viewChild<NgForm>("form");
  destroyRef = inject(DestroyRef);

  constructor() {
    afterNextRender(() => {
      const jsonLogin = window.localStorage.getItem("user-login-form");

      if (jsonLogin) {
        const parseLogin = JSON.parse(jsonLogin);
        const savedEmail = parseLogin.email;
        console.log("Saved Email:", savedEmail);
        setTimeout(() => {
          this.formView()?.setValue({
            email: savedEmail || "",
            password: "", // ƒê·∫∑t password r·ªóng v√¨ kh√¥ng l∆∞u tr·ªØ password trong localStorage
          });
          // Ho·∫∑c c√≥ th·ªÉ set cho t·ª´ng tr∆∞·ªùng ri√™ng l·∫ª
          // this.formView()?.controls["email"].setValue(savedEmail || "");
        }, 1); // s·ª≠ d·ª•ng setTimeout ƒë·ªÉ ƒë·∫£m b·∫£o r·∫±ng form ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o tr∆∞·ªõc khi set gi√° tr·ªã
      }

      // s·ª≠ d·ª•ng afterNextRender ƒë·ªÉ ƒë·∫£m b·∫£o r·∫±ng form ƒë√£ ƒë∆∞·ª£c render (v√¨ th·∫ø c·∫ßn ph·∫£i viewChild ƒë·ªÉ l·∫•y ƒë∆∞·ª£c th√¥ng tin form)
      const sub = this.formView()
        ?.valueChanges?.pipe(debounceTime(500)) // valueChange (l·∫Øng nghe form c√≥ thay ƒë·ªïi d·ªØ li·ªáu kh√¥ng => tr·∫£ v·ªÅ 1 observables), debounceTime (ch·ªù 500ms tr∆∞·ªõc khi ph√°t ra gi√° tr·ªã m·ªõi, tr√°nh vi·ªác ph√°t ra qu√° nhi·ªÅu gi√° tr·ªã g√¢y ngh·∫Ωn)
        .subscribe({
          next: (val) =>
            window.localStorage.setItem(
              "user-login-form",
              JSON.stringify({ email: val.email })
            ),
        });

      this.destroyRef.onDestroy(() => {
        sub?.unsubscribe();
      });
    });
  }

  onSubmit(form: NgForm) {
    const enteredEmail = form.form.value.email;
    const enteredPassword = form.form.value.password;

    if (form.invalid) {
      return;
    }
    console.log("Email:", enteredEmail);
    console.log("Password:", enteredPassword);
    form.resetForm(); // Reset the form after submission
  }
}

```

## 4. Reactive Forms
- Reactive Forms cung c·∫•p m·ªôt c√°ch ti·∫øp c·∫≠n m·∫°nh m·∫Ω v√† linh ho·∫°t h∆°n ƒë·ªÉ l√†m vi·ªác v·ªõi c√°c bi·ªÉu m·∫´u trong Angular.
- Thay v√¨ s·ª≠ d·ª•ng ngModel ƒë·ªÉ li√™n k·∫øt d·ªØ li·ªáu, Reactive Forms s·ª≠ d·ª•ng FormGroup v√† FormControl ƒë·ªÉ qu·∫£n l√Ω tr·∫°ng th√°i v√† gi√° tr·ªã c·ªßa c√°c tr∆∞·ªùng trong bi·ªÉu m·∫´u.
- ƒêi·ªÅu n√†y cho ph√©p b·∫°n d·ªÖ d√†ng ki·ªÉm so√°t v√† theo d√µi c√°c thay ƒë·ªïi trong bi·ªÉu m·∫´u, c≈©ng nh∆∞ th·ª±c hi·ªán c√°c x√°c th·ª±c ph·ª©c t·∫°p h∆°n.
- Trong `Reactive Form` ch√∫ng ta s·∫Ω l√†m quen v·ªõi c√°c thu·∫≠t ng·ªØ:
  - `formGroup`: ƒë·∫°i di·ªán cho m·ªôt nh√≥m c√°c tr∆∞·ªùng trong bi·ªÉu m·∫´u.
  - `formControl`: ƒë·∫°i di·ªán cho m·ªôt tr∆∞·ªùng trong bi·ªÉu m·∫´u.
  - `formControlName`: ƒë·∫°i di·ªán cho t√™n c·ªßa m·ªôt tr∆∞·ªùng trong bi·ªÉu m·∫´u, ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ li√™n k·∫øt m·ªôt `FormControl` v·ªõi m·ªôt tr∆∞·ªùng trong template.
  - `ReactiveFormsModule`: module c·∫ßn thi·∫øt ƒë·ªÉ s·ª≠ d·ª•ng Reactive Forms trong Angular.
  - `ngSubmit`: s·ª± ki·ªán ƒë∆∞·ª£c ph√°t ra khi ng∆∞·ªùi d√πng g·ª≠i bi·ªÉu m·∫´u.

ƒê·ªÉ s·ª≠ d·ª•ng Reactive Forms, b·∫°n c·∫ßn th·ª±c hi·ªán c√°c b∆∞·ªõc sau:
1. Import `ReactiveFormsModule` v√†o module c·ªßa b·∫°n (thay v√¨ `FormsModule`).
```ts
// ...
import { ReactiveFormsModule } from "@angular/forms";
@Component({
  // ...
  imports: [ReactiveFormsModule]
})
```
2. T·∫°o m·ªôt `FormGroup` trong component c·ªßa b·∫°n ƒë·ªÉ ƒë·∫°i di·ªán cho bi·ªÉu m·∫´u.
```ts
// ...
export class Example {
  form = new FormGroup({
    email: new FormControl(""), // Kh·ªüi t·∫°o gi√° tr·ªã ƒë·∫ßu ti√™n l√† m·ªôt chu·ªói r·ªóng
    password: new FormControl("") // Kh·ªüi t·∫°o gi√° tr·ªã ƒë·∫ßu ti√™n l√† m·ªôt chu·ªói r·ªóng
  })
}
```
3. S·ª≠ d·ª•ng `formControlName` ho·∫∑c `formControl` v√† `formGroup` trong template ƒë·ªÉ li√™n k·∫øt c√°c tr∆∞·ªùng v·ªõi `FormControl` t∆∞∆°ng ·ª©ng trong `FormGroup`.
```html
<form [formGroup]="form" (ngSubmit)="onSubmit()">
  <h2>Login</h2>

  <div class="control-row">
    <div class="control no-margin">
      <label for="email">Email</label>
      <input id="email" type="email" [formControl]="form.controls.email" />
    </div>

    <div class="control no-margin">
      <label for="password">Password</label>
      <input id="password" type="password" formControlName="password" />
    </div>

    <button class="button">Login</button>
  </div>
</form>

```
4. X·ª≠ l√Ω s·ª± ki·ªán `ngSubmit` ƒë·ªÉ l·∫•y gi√° tr·ªã c·ªßa bi·ªÉu m·∫´u khi ng∆∞·ªùi d√πng g·ª≠i (kh√¥ng c·∫ßn truy·ªÅn b·∫•t c·ª© g√¨ v√†o h√†m `onSubmit` v√¨ ch√∫ng ta ƒë√£ li√™n k·∫øt bi·ªÉu m·∫´u v·ªõi `FormGroup`).
```ts
//...
onSubmit() {
  console.log(this.form.value)
}
```

### 4.1. Validate d·ªØ li·ªáu
- Angular c≈©ng cung c·∫•p cho c√°c class CSS ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i h·ª£p l·ªá c·ªßa form nh∆∞ (ch√∫ng ta s·ª≠ d·ª•ng c√°c class n√†y ƒë·ªÉ style css):
  - `ng-valid` - tr·∫°ng th√°i h·ª£p l·ªá
  - `ng-invalid` - tr·∫°ng th√°i kh√¥ng h·ª£p l·ªá
  - `ng-pristine` - tr·∫°ng th√°i ch∆∞a thay ƒë·ªïi (ng∆∞·ªùi d√πng ch∆∞a nh·∫≠p g√¨)
  - `ng-dirty` - tr·∫°ng th√°i ƒë√£ thay ƒë·ªïi.
  - `ng-touched` - tr·∫°ng th√°i ƒë√£ ƒë∆∞·ª£c ng∆∞·ªùi d√πng t∆∞∆°ng t√°c (focus v√† blur).
  - `ng-submitted` - tr·∫°ng th√°i ƒë√£ ƒë∆∞·ª£c g·ª≠i (submit).
  - `ng-untouched` - tr·∫°ng th√°i ch∆∞a ƒë∆∞·ª£c ng∆∞·ªùi d√πng t∆∞∆°ng t√°c.

- Kh√°c v·ªõi `Form-template`, `Reactive Form` kh√¥ng s·ª≠ d·ª•ng c√°c thu·ªôc t√≠nh nh∆∞ `required`, `minlength`, `maxlength`, `pattern`, v.v. ƒë·ªÉ ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa form, m√† s·ª≠ d·ª•ng c√°c ph∆∞∆°ng th·ª©c c·ªßa `Validators` ƒë·ªÉ ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa form. C√°c ph∆∞∆°ng th·ª©c ƒë√≥ ƒë∆∞·ª£c s·ª≠ d·ª•ng trong `FormControl` c·ªßa t·ª´ng tr∆∞·ªùng.
```ts
import { Validators } from "@angular/forms";

this.form = new FormGroup({
  email: new FormControl("", {
    validators: [Validators.required, Validators.email],
  }),
  password: new FormControl("", {
    validators: [Validators.required, Validators.minLength(6)],
  }),
});
```
> Ngo√†i thu·ªôc t√≠nh `validators`, c√≤n c√≥ `asyncValidators` cho ph√©p b·∫°n x√°c th·ª±c b·∫•t ƒë·ªìng b·ªô (nh∆∞ ki·ªÉm tra email ƒë√£ t·ªìn t·∫°i hay ch∆∞a), `updateOn` ƒë·ªÉ ch·ªâ ƒë·ªãnh th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t gi√° tr·ªã v√† tr·∫°ng th√°i c·ªßa `FormControl` (v√≠ d·ª•: `change`, `blur`, `submit`), `nonNullable` ƒë·ªÉ ch·ªâ ƒë·ªãnh r·∫±ng gi√° tr·ªã c·ªßa `FormControl` kh√¥ng bao gi·ªù l√† null.

```ts
import { Component } from "@angular/core";
import {
  FormControl,
  FormGroup,
  ReactiveFormsModule,
  Validators,
} from "@angular/forms";

@Component({
  selector: "app-login",
  standalone: true,
  templateUrl: "./login.component.html",
  styleUrl: "./login.component.css",
  imports: [ReactiveFormsModule],
})
export class LoginComponent {
  form = new FormGroup({
    email: new FormControl("", {
      validators: [Validators.required, Validators.email],
    }),
    password: new FormControl("", {
      validators: [Validators.required, Validators.minLength(6)],
    }),
  });

  get isValidEmail() {
    return (
      this.form.controls.email.touched &&
      this.form.controls.email.dirty &&
      this.form.controls.email.invalid
    );
  }

  get isValidPassword() {
    return (
      this.form.controls.password.touched &&
      this.form.controls.password.dirty &&
      this.form.controls.password.invalid
    );
  }

  onSubmit() {
    console.log(this.form.value);
  }
}
```
```html
<form [formGroup]="form" (ngSubmit)="onSubmit()">
  <h2>Login</h2>

  <div class="control-row">
    <div class="control no-margin">
      <label for="email">Email</label>
      <input id="email" type="email" [formControl]="form.controls.email" />
    </div>

    <div class="control no-margin">
      <label for="password">Password</label>
      <input id="password" type="password" formControlName="password" />
    </div>

    <button class="button">Login</button>
  </div>

  @if (isValidEmail) {
    <p class="control-error">Email is invalid</p>
  }

  @if (isValidPassword) {
    <p class="control-error">Password is invalid</p>
  }
</form>
```
### 4.2. T·∫°o custom validate
Ngo√†i `directive`, ch√∫ng ta c√≥ th·ªÉ t·∫°o custom validate cho `FormControl` b·∫±ng c√°ch t·∫°o m·ªôt h√†m validate v√† truy·ªÅn v√†o `validators` c·ªßa `FormControl`.

```ts
import { AbstractControl } from "@angular/forms";

function mustContainQuestionMark(control: AbstractControl) {
  if (control.value.includes("?")) {
    return null; // Valid
  }
  return { notContainQuestionMark: true }; // Invalid
}

@Component({
  selector: "app-login",
  standalone: true,
  templateUrl: "./login.component.html",
  styleUrl: "./login.component.css",
  imports: [ReactiveFormsModule],
})
export class LoginComponent {
  form = new FormGroup({
    email: new FormControl("", {
      validators: [Validators.required, Validators.email],
    }),
    password: new FormControl("", {
      validators: [Validators.required, Validators.minLength(6), mustContainQuestionMark],
      // c√≥ th·ªÉ truy·ªÅn ch·ªâ ƒë·ªãnh tr∆∞·ªùng v√†o validators v√≠ d·ª• mustContainQuestionMark("password"), m·∫∑c ƒë·ªãnh kh√¥ng truy·ªÅn th√¨ s·∫Ω ki·ªÉm tra tr∆∞·ªùng hi·ªán t·∫°i ƒë∆∞·ª£c ƒë∆∞a v√†o.
    }),
  });

  get isValidEmail() {
    return (
      this.form.controls.email.touched &&
      this.form.controls.email.dirty &&
      this.form.controls.email.invalid
    );
  }

  get isValidPassword() {
    return (
      this.form.controls.password.touched &&
      this.form.controls.password.dirty &&
      this.form.controls.password.invalid
    );
  }

  onSubmit() {
    console.log(this.form.value);
  }
}
```


### 4.3. S·ª≠ d·ª•ng `asyncValidators`
`asyncValidators` cho ph√©p b·∫°n th·ª±c hi·ªán x√°c th·ª±c b·∫•t ƒë·ªìng b·ªô, ch·∫≥ng h·∫°n nh∆∞ ki·ªÉm tra xem email ƒë√£ t·ªìn t·∫°i hay ch∆∞a trong db tr∆∞·ªõc khi ƒëi ti·∫øp. ƒê·ªÉ s·ª≠ d·ª•ng `asyncValidators`, b·∫°n c·∫ßn truy·ªÅn m·ªôt h√†m tr·∫£ v·ªÅ m·ªôt `Observable` v√†o `asyncValidators` c·ªßa `FormControl`.

```ts
import { AbstractControl } from "@angular/forms";
import { of } from "rxjs";
import { map, delay } from "rxjs/operators";

function emailExists(control: AbstractControl) {
  const email = control.value;
  return of(email).pipe(
    delay(1000), // Gi·∫£ l·∫≠p g·ªçi API
    map((email) => {
      return email === "test@example.com"
        ? { emailExists: true }
        : null;
    })
  );
}

@Component({
  selector: "app-login",
  standalone: true,
  templateUrl: "./login.component.html",
  styleUrl: "./login.component.css",
  imports: [ReactiveFormsModule],
})
export class LoginComponent {
  form = new FormGroup({
    email: new FormControl("", {
      validators: [Validators.required, Validators.email],
      asyncValidators: [emailExists],
    }),
    password: new FormControl("", {
      validators: [Validators.required, Validators.minLength(6), mustContainQuestionMark],
    }),
  });

  get isValidEmail() {
    return (
      this.form.controls.email.touched &&
      this.form.controls.email.dirty &&
      this.form.controls.email.invalid
    );
  }

  get isValidPassword() {
    return (
      this.form.controls.password.touched &&
      this.form.controls.password.dirty &&
      this.form.controls.password.invalid
    );
  }

  onSubmit() {
    console.log(this.form.value);
  }
}
```

### 4.4. Kh·ªüi t·∫°o gi√° tr·ªã m·∫∑c ƒë·ªãnh
V·ªõi `Reactive Form` b·∫°n c√≥ th·ªÉ kh·ªüi t·∫°o gi√° tr·ªã m·∫∑c ƒë·ªãnh cho c√°c tr∆∞·ªùng trong `FormGroup` b·∫±ng c√°ch truy·ªÅn gi√° tr·ªã v√†o khi t·∫°o `FormControl`. N·∫øu b·∫°n mu·ªën kh·ªüi t·∫°o gi√° tr·ªã m·∫∑c ƒë·ªãnh cho to√†n b·ªô form, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng ph∆∞∆°ng th·ª©c `setValue` ho·∫∑c `patchValue` (ch·ªâ c·∫≠p nh·∫≠t 1 ph·∫ßn, c√≤n l·∫°i gi·ªØ nguy√™n) ƒë·ªÉ c·∫≠p nh·∫≠t gi√° tr·ªã c·ªßa form sau khi ƒë√£ kh·ªüi t·∫°o.

> Kh·ªüi t·∫°o ngay l√∫c khai b√°o
```ts
import { FormGroup, FormControl } from "@angular/forms";

@Component({
  selector: "app-login",
  standalone: true,
  templateUrl: "./login.component.html",
  styleUrl: "./login.component.css",
  imports: [ReactiveFormsModule],
})
export class LoginComponent {
  form = new FormGroup({
    email: new FormControl("test@example.com", {
      validators: [Validators.required, Validators.email],
    }),
    password: new FormControl("123456?", {
      validators: [Validators.required, Validators.minLength(6), mustContainQuestionMark],
    }),
  });
}
```

V√≠ d·ª• ƒë·∫ßy ƒë·ªß:
```ts
import { Component, DestroyRef, inject, OnInit } from "@angular/core";
import {
  AbstractControl,
  FormControl,
  FormGroup,
  ReactiveFormsModule,
  Validators,
} from "@angular/forms";
import { debounceTime, delay, map, of } from "rxjs";

function mustContainQuestionMark(control: AbstractControl) {
  if (control.value.includes("?")) {
    return null; // Valid
  }
  return { notContainQuestionMark: true }; // Invalid
}

function isNotDuplicate(control: AbstractControl) {
  const email = control.value;
  return of(email).pipe(
    delay(1000), // Gi·∫£ l·∫≠p ƒëang g·ªçi ƒë·∫øn backend check tr√πng (tr·ªÖ 1s)
    map((email) => {
      if (email === "messiprohy@gmail.com") return { isDuplicate: true };
      return null;
    })
  );
}

/**
 * D√πng init set v√†o FormControl
 * */
let initialEmailValue = "";
const savedForm = window.localStorage.getItem("saved-login-form");

if (savedForm) {
  const loadedForm = JSON.parse(savedForm);
  initialEmailValue = loadedForm.email;
}
@Component({
  selector: "app-login",
  standalone: true,
  templateUrl: "./login.component.html",
  styleUrl: "./login.component.css",
  imports: [ReactiveFormsModule],
})
export class LoginComponent implements OnInit {
  destroyRef = inject(DestroyRef);

  form = new FormGroup({
    email: new FormControl(initialEmailValue, {
      validators: [Validators.required, Validators.email],
      asyncValidators: [isNotDuplicate],
    }),
    password: new FormControl("", {
      validators: [
        Validators.required,
        Validators.minLength(6),
        mustContainQuestionMark,
      ],
    }),
  });

  get isValidEmail() {
    return (
      this.form.controls.email.touched &&
      this.form.controls.email.dirty &&
      this.form.controls.email.invalid
    );
  }

  get isValidPassword() {
    return (
      this.form.controls.password.touched &&
      this.form.controls.password.dirty &&
      this.form.controls.password.invalid
    );
  }

  ngOnInit(): void {
    /** D√πng patchValue */
    // const savedForm = window.localStorage.getItem("saved-login-form");

    // if (savedForm) {
    //   const loadedForm = JSON.parse(savedForm);
    //   this.form.patchValue({
    //     email: loadedForm.email,
    //   });
    // }
    const sub = this.form.valueChanges.pipe(debounceTime(500)).subscribe({
      next: (value) => {
        window.localStorage.setItem(
          "saved-login-form",
          JSON.stringify({ email: value.email })
        );
      },
    });
    this.destroyRef.onDestroy(() => {
      sub.unsubscribe();
    });
  }

  onSubmit() {
    console.log(this.form.value);
  }
}
```

### 4.5. L·ªìng c√°c FormGroup
Trong 1 form, c√≥ th·ªÉ c√≥ nhi·ªÅu tr∆∞·ªùng, v√† b·∫°n c√≥ th·ªÉ nh√≥m ch√∫ng l·∫°i v·ªõi nhau b·∫±ng c√°ch s·ª≠ d·ª•ng `FormGroup`. V√≠ d·ª•, trong form ƒëƒÉng k√Ω, b·∫°n c√≥ th·ªÉ nh√≥m c√°c tr∆∞·ªùng li√™n quan ƒë·∫øn ƒë·ªãa ch·ªâ l·∫°i v·ªõi nhau trong m·ªôt `FormGroup`.
Ngo√†i ra nh√≥m `FormGroup` ƒë√≥ c√≥ th·ªÉ th√™m validate chung cho c·∫£ nh√≥m k·∫øt h·ª£p v·ªõi c√°c validate ri√™ng c·ªßa t·ª´ng tr∆∞·ªùng.
```ts
import { Component } from "@angular/core";
import {
  AbstractControl,
  FormArray,
  FormControl,
  FormGroup,
  ReactiveFormsModule,
  Validators,
} from "@angular/forms";

function equalPassword(control: AbstractControl) {
  // const { password, confirmPassword } = control.value;
  const password = control.get("password")?.value; // N√™n d√πng c√°ch n√†y
  const confirmPassword = control.get("confirmPassword")?.value; // N√™n d√πng c√°ch n√†y

  console.log(password, confirmPassword);
  if (password !== confirmPassword) {
    return { notMatching: true };
  }
  return null;
}

@Component({
  selector: "app-signup",
  standalone: true,
  templateUrl: "./signup.component.html",
  styleUrl: "./signup.component.css",
  imports: [ReactiveFormsModule],
})
export class SignupComponent {
  form = new FormGroup({
    email: new FormControl("", {
      validators: [Validators.required, Validators.email],
    }),
    passwords: new FormGroup(
      {
        password: new FormControl("", {
          validators: [Validators.required, Validators.minLength(6)],
        }),
        confirmPassword: new FormControl("", {
          validators: [Validators.required, Validators.minLength(6)],
        }),
      },
      {
        validators: [equalPassword],
      }
    ),
    firstName: new FormControl("", {
      validators: [Validators.required],
    }),
    lastName: new FormControl("", {
      validators: [Validators.required],
    }),
    address: new FormGroup({
      street: new FormControl("", {
        validators: [Validators.required],
      }),
      number: new FormControl("", {
        validators: [Validators.required],
      }),
      postalCode: new FormControl("", {
        validators: [Validators.required],
      }),
      city: new FormControl("", {
        validators: [Validators.required],
      }),
    }),
    role: new FormControl<
      "student" | "teacher" | "employee" | "founder" | "other"
    >("student", {
      validators: [Validators.required],
    }),
    source: new FormArray([
      new FormControl(false),
      new FormControl(false),
      new FormControl(false),
    ]),
    agree: new FormControl(false, {
      validators: [Validators.requiredTrue],
    }),
  });

  onSubmit() {
    console.log(this.form.value);
  }

  onReset() {
    this.form.reset();
  }
}

```
> ƒê·ªëi v·ªõi template, b·∫°n c·∫ßn 1 th·∫ª tag ƒë·ªÉ b·ªçc c√°c tr∆∞·ªùng trong `FormGroup` l·∫°i v·ªõi nhau. V·ªõi c√°c th·∫ª kh√¥ng ph·∫£i l√† `form`, b·∫°n d√πng `formGroupName="<t√™n nh√≥m>"` ho·∫∑c `[formGroup]="form.controls.<t√™n nh√≥m>"` ƒë·ªÉ ch·ªâ ƒë·ªãnh nh√≥m cho c√°c tr∆∞·ªùng.
> V·ªõi template c√≥ form t√πy ch·ªçn nhi·ªÅu tr∆∞·ªùng, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng `formArrayName="<t√™n m·∫£ng>"` ƒë·ªÉ ch·ªâ ƒë·ªãnh m·∫£ng cho c√°c tr∆∞·ªùng, sau ƒë√≥ trong t·ª´ng tr∆∞·ªùng b·∫°n d√πng `formControlName="<index></index>"` t∆∞∆°ng ·ª©ng v·ªõi index v·ªã tr√≠ c√°c tr∆∞·ªùng trong m·∫£ng khai b√°o `new FormArray()`.
V√≠ d·ª•:
```html
<form [formGroup]="form" (ngSubmit)="onSubmit()">
  <h2>Welcome on board!</h2>
  <p>We just need a little bit of data from you to get you started üöÄ</p>

  <div class="control">
    <label for="email">Email</label>
    <input id="email" type="email" name="email" formControlName="email" />
  </div>

  <div class="control-row" formGroupName="passwords">
    <div class="control">
      <label for="password">Password</label>
      <input
        id="password"
        type="password"
        name="password"
        formControlName="password"
      />
    </div>

    <div class="control">
      <label for="confirm-password">Confirm Password</label>
      <input
        id="confirm-password"
        type="password"
        name="confirm-password"
        formControlName="confirmPassword"
      />
    </div>
  </div>

  <hr />

  <div>
    <div class="control-row">
      <div class="control">
        <label for="first-name">First Name</label>
        <input
          type="text"
          id="first-name"
          name="first-name"
          formControlName="firstName"
        />
      </div>

      <div class="control">
        <label for="last-name">Last Name</label>
        <input
          type="text"
          id="last-name"
          name="last-name"
          formControlName="lastName"
        />
      </div>
    </div>

    <fieldset formGroupName="address">
      <legend>Your Address</legend>

      <div class="control-row">
        <div class="control">
          <label for="street">Street</label>
          <input type="text" id="street" name="street" formControlName="street" />
        </div>

        <div class="control">
          <label for="number">Number</label>
          <input type="text" id="number" name="number" formControlName="number" />
        </div>
      </div>

      <div class="control-row">
        <div class="control">
          <label for="postal-code">Postal Code</label>
          <input type="text" id="postal-code" name="postal-code" formControlName="postalCode" />
        </div>

        <div class="control">
          <label for="city">City</label>
          <input type="text" id="city" name="city" formControlName="city" />
        </div>
      </div>
    </fieldset>
  </div>

  <hr />

  <div class="control-row">
    <div class="control">
      <label for="role">What best describes your role?</label>
      <select id="role" name="role" formControlName="role">
        <option value="student">Student</option>
        <option value="teacher">Teacher</option>
        <option value="employee">Employee</option>
        <option value="founder">Founder</option>
        <option value="other">Other</option>
      </select>
    </div>
  </div>

  <fieldset formArrayName="source">
    <legend>How did you find us?</legend>
    <div class="control">
      <input
        type="checkbox"
        id="google"
        name="acquisition"
        value="google"
        formControlName="0"
      />
      <label for="google">Google</label>
    </div>

    <div class="control">
      <input
        type="checkbox"
        id="friend"
        name="acquisition"
        value="friend"
        formControlName="1"
      />
      <label for="friend">Referred by friend</label>
    </div>

    <div class="control">
      <input
        type="checkbox"
        id="other"
        name="acquisition"
        value="other"
        formControlName="2"
      />
      <label for="other">Other</label>
    </div>
  </fieldset>

  <div class="control-row">
    <div class="control">
      <label for="terms-and-conditions">
        <input
          type="checkbox"
          id="terms-and-conditions"
          name="terms"
          formControlName="agree"
        />
        I agree to the terms and conditions
      </label>
    </div>
  </div>

  <p class="form-actions">
    <button type="reset" class="button button-flat" (click)="onReset()">Reset</button>
    <button type="submit" class="button">Sign up</button>
  </p>
</form>

```

## 5. Reactive Form n√¢ng cao
### 5.1. `FormBuilder`
- `FormBuilder` gi√∫p t·∫°o form g·ªçn h∆°n v√† t·ª± ƒë·ªông √°p d·ª•ng ki·ªÉu. D√πng `nonNullable` ƒë·ªÉ ch·∫Øc ch·∫Øn gi√° tr·ªã kh√¥ng th·ªÉ `null`.
```ts
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';

@Component({
  // ...
})
export class ProfileFormComponent {
  private readonly fb = inject(FormBuilder);

  readonly form = this.fb.nonNullable.group({
    displayName: ['', [Validators.required, Validators.minLength(4)]],
    notifications: this.fb.nonNullable.group({
      email: true,
      sms: false,
    }),
  });
}
```

### 5.2. `FormArray`
- D√πng cho danh s√°ch ƒë·ªông (th√™m/x√≥a input). V√≠ d·ª• thu th·∫≠p nhi·ªÅu s·ªë ƒëi·ªán tho·∫°i:
```ts
phones = this.fb.array([this.fb.control('', Validators.required)]);

addPhone() {
  this.phones.push(this.fb.control(''));
}

removePhone(index: number) {
  this.phones.removeAt(index);
}
```
```html
<div formArrayName="phones">
  <div *ngFor="let phoneCtrl of phones.controls; let i = index">
    <input [formControlName]="i" placeholder="S·ªë ƒëi·ªán tho·∫°i" />
    <button type="button" (click)="removePhone(i)">X√≥a</button>
  </div>
  <button type="button" (click)="addPhone()">Th√™m s·ªë</button>
</div>
```

### 5.3. Typed forms (Angular 14+)
- Khi b·∫≠t `@angular/forms` strict typing (`"angularCompilerOptions": { "strictTemplates": true }`), b·∫°n c√≥ th·ªÉ ƒë·ªãnh nghƒ©a interface cho form ƒë·ªÉ ƒë∆∞·ª£c auto-complete t·ªët h∆°n.
```ts
interface SignupForm {
  email: FormControl<string>;
  password: FormControl<string>;
  agree: FormControl<boolean>;
}

readonly form = new FormGroup<SignupForm>({
  email: new FormControl('', { nonNullable: true }),
  password: new FormControl('', { nonNullable: true }),
  agree: new FormControl(false, { nonNullable: true }),
});
```

## 6. T·∫°o control t√πy ch·ªânh v·ªõi `ControlValueAccessor`
- Khi b·∫°n c√≥ component input t√πy ch·ªânh (datepicker, rich text editor), h√£y tri·ªÉn khai `ControlValueAccessor` ƒë·ªÉ form Angular c√≥ th·ªÉ ƒëi·ªÅu khi·ªÉn n√≥.
```ts
@Component({
  selector: 'app-rating-control',
  templateUrl: './rating-control.component.html',
  providers: [{
    provide: NG_VALUE_ACCESSOR,
    useExisting: forwardRef(() => RatingControlComponent),
    multi: true,
  }],
})
export class RatingControlComponent implements ControlValueAccessor {
  value = 0;
  private onChange = (value: number) => {};
  private onTouched = () => {};

  writeValue(value: number): void {
    this.value = value ?? 0;
  }
  registerOnChange(fn: (value: number) => void): void {
    this.onChange = fn;
  }
  registerOnTouched(fn: () => void): void {
    this.onTouched = fn;
  }
  setDisabledState(isDisabled: boolean) {
    this.disabled = isDisabled;
  }

  rate(value: number) {
    this.value = value;
    this.onChange(value);
  }
}
```
- V·ªõi `ControlValueAccessor`, component t√πy ch·ªânh s·∫Ω ho·∫°t ƒë·ªông gi·ªëng h·ªát `input` m·∫∑c ƒë·ªãnh: nh·∫≠n gi√° tr·ªã t·ª´ form, ph√°t s·ª± ki·ªán `touched`, `dirty`, h·ªó tr·ª£ `setDisabledState`.

## 7. Tips ki·ªÉm th·ª≠ v√† g·ª° l·ªói form
- **Log tr·∫°ng th√°i control**: Trong template, t·∫°o ti·ªán √≠ch `{{ control.errors | json }}` ƒë·ªÉ th·∫•y rule n√†o ƒëang th·∫•t b·∫°i. Khi ho√†n t·∫•t, h√£y x√≥a ho·∫∑c ·∫©n ƒë·∫±ng sau `ngIf`.
- **Unit test**: V·ªõi Reactive Form, b·∫°n ch·ªâ c·∫ßn set value v√† mong ƒë·ª£i tr·∫°ng th√°i:
```ts
it('kh√¥ng h·ª£p l·ªá khi thi·∫øu email', () => {
  component.form.controls.email.setValue('');
  expect(component.form.invalid).toBeTrue();
});
```
- **E2E**: Vi·∫øt test Playwright/Cypress g·ª≠i form, ki·ªÉm tra th√¥ng b√°o l·ªói hi·ªÉn th·ªã ƒë√∫ng. ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o v√≠ d·ª• trong t√†i li·ªáu kh√¥ng ch·ªâ ho·∫°t ƒë·ªông tr√™n l√Ω thuy·∫øt.
- **Hi·ªáu nƒÉng**: V·ªõi form l·ªõn, b·∫≠t `updateOn: 'blur'` ho·∫∑c `'submit'` ƒë·ªÉ gi·∫£m s·ªë l·∫ßn ch·∫°y validation. K·∫øt h·ª£p `ChangeDetectionStrategy.OnPush` khi component c√≥ nhi·ªÅu tr∆∞·ªùng nh∆∞ng kh√¥ng ph·ª• thu·ªôc d·ªØ li·ªáu ngo√†i.
