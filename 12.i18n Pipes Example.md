# Ví dụ i18n với 2 ngôn ngữ (Việt - Anh) dùng Pipe dịch

Tài liệu này hướng dẫn cấu hình i18n cơ bản bằng cách tự tạo `TranslatePipe`. Mục tiêu: người học hiểu cách tổ chức dữ liệu dịch, chuyển đổi ngôn ngữ/runtime, và áp dụng pipe trong template.

## 1. Chuẩn bị
1. Cài Angular Localize (giúp định dạng số/ngày chuẩn locale): `ng add @angular/localize`.
2. Đăng ký locale Việt Nam trong `main.ts`:
```ts
import localeVi from '@angular/common/locales/vi';
import { registerLocaleData } from '@angular/common';

registerLocaleData(localeVi);
```
3. Tạo thư mục `src/app/i18n` chứa dữ liệu và pipe.

## 2. Dữ liệu bản dịch
Tạo file `translations.ts`:
```ts
export type SupportedLocale = 'vi' | 'en';

export const translations: Record<SupportedLocale, Record<string, string>> = {
  vi: {
    'app.title': 'Ứng dụng Angular Demo',
    'nav.home': 'Trang chủ',
    'nav.about': 'Giới thiệu',
    'cta.buy': 'Mua ngay',
    'language.vi': 'Tiếng Việt',
    'language.en': 'Tiếng Anh',
    'home.welcome': 'Chào {{name}}!',
  },
  en: {
    'app.title': 'Angular Demo App',
    'nav.home': 'Home',
    'nav.about': 'About',
    'cta.buy': 'Buy now',
    'language.vi': 'Vietnamese',
    'language.en': 'English',
    'home.welcome': 'Hello {{name}}!',
  },
};
```
- Khóa dùng cú pháp `module.section.key` để dễ tìm.
- Khi cần placeholder, đặt `{{name}}` và thay bằng `replace`.

## 3. LanguageStore (Signal)
`language.store.ts`
```ts
import { Injectable, signal } from '@angular/core';
import { SupportedLocale } from './translations';

@Injectable({ providedIn: 'root' })
export class LanguageStore {
  private readonly _locale = signal<SupportedLocale>('vi');

  readonly locale = this._locale.asReadonly();

  setLocale(locale: SupportedLocale) {
    this._locale.set(locale);
    localStorage.setItem('app-locale', locale);
  }

  restore() {
    const saved = localStorage.getItem('app-locale') as SupportedLocale | null;
    if (saved) this._locale.set(saved);
  }
}
```
- Gọi `languageStore.restore()` trong `AppComponent` để lấy giá trị đã lưu.
- Sử dụng signal giúp pipe tự cập nhật khi ngôn ngữ đổi.

## 4. Tạo `TranslatePipe`
`translate.pipe.ts`
```ts
import { ChangeDetectorRef, Pipe, PipeTransform } from '@angular/core';
import { LanguageStore } from './language.store';
import { translations } from './translations';

@Pipe({
  name: 'translate',
  standalone: true,
  pure: false, // pipe phụ thuộc vào signal nên cần chạy lại mỗi lần locale đổi
})
export class TranslatePipe implements PipeTransform {
  private currentLocale = this.language.locale();

  constructor(private language: LanguageStore, private cdRef: ChangeDetectorRef) {
    this.language.locale.effect(locale => {
      this.currentLocale = locale;
      this.cdRef.markForCheck();
    });
  }

  transform(key: string, params?: Record<string, string | number>): string {
    const dictionary = translations[this.currentLocale] ?? {};
    let value = dictionary[key] ?? key;
    if (params) {
      Object.entries(params).forEach(([k, v]) => {
        value = value.replace(new RegExp(`{{\\s*${k}\\s*}}`, 'g'), String(v));
      });
    }
    return value;
  }
}
```
- Đặt `pure: false` để pipe chạy lại khi `locale` thay đổi.
- Có thể cải tiến: cảnh báo nếu key thiếu, hỗ trợ fallback `en`.

## 5. Component ví dụ
`language-switcher.component.ts`
```ts
import { Component, inject } from '@angular/core';
import { TranslatePipe } from '../i18n/translate.pipe';
import { LanguageStore } from '../i18n/language.store';

@Component({
  selector: 'app-language-switcher',
  standalone: true,
  imports: [TranslatePipe],
  template: `
    <button type="button" (click)="setLocale('vi')">
      {{ 'language.vi' | translate }}
    </button>
    <button type="button" (click)="setLocale('en')">
      {{ 'language.en' | translate }}
    </button>
  `,
})
export class LanguageSwitcherComponent {
  private readonly store = inject(LanguageStore);
  setLocale(locale: 'vi' | 'en') {
    this.store.setLocale(locale);
  }
}
```

`app.component.ts`
```ts
import { Component, OnInit, inject } from '@angular/core';
import { TranslatePipe } from './i18n/translate.pipe';
import { LanguageSwitcherComponent } from './shared/language-switcher.component';
import { LanguageStore } from './i18n/language.store';

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [TranslatePipe, LanguageSwitcherComponent],
  template: `
    <header>
      <h1>{{ 'app.title' | translate }}</h1>
      <app-language-switcher />
    </header>

    <main>
      <h2>{{ 'home.welcome' | translate:{ name: userName } }}</h2>
      <a routerLink="/">{{ 'nav.home' | translate }}</a>
    </main>
  `,
})
export class AppComponent implements OnInit {
  userName = 'Angular Dev';
  private readonly store = inject(LanguageStore);
  ngOnInit() {
    this.store.restore();
  }
}
```

## 6. Định dạng số/ngày theo locale đang chọn
```ts
providers: [
  {
    provide: LOCALE_ID,
    deps: [LanguageStore],
    useFactory: (store: LanguageStore) => store.locale(),
  },
]
```
- Khi `LOCALE_ID` thay đổi, Angular Pipes như `date`, `currency` sẽ dùng format tương ứng. Nếu bạn chỉ muốn dịch text nhưng giữ định dạng mặc định, bỏ qua bước này.

## 7. Gắn với router và SEO
- Thêm prefix `/vi` `/en` vào router, sau đó trong `LanguageStore.setLocale` điều hướng tới route tương ứng (`this.router.navigate(['/', locale, ...])`).
- Dùng `TitleStrategy` hoặc `Meta` service kết hợp `translate` pipe (hoặc `LanguageStore`) để cập nhật title/meta mỗi khi ngôn ngữ đổi.

## 8. Khi nào dùng giải pháp khác?
- Cách này phù hợp với dự án nhỏ hoặc tài liệu học. Với dự án lớn bạn nên dùng:
  - Angular Localize (compile-time) khi số lượng ngôn ngữ ít và không cần đổi tại runtime.
  - Transloco hoặc `@ngx-translate/core` khi cần lazy load bản dịch, phân quyền người dịch, hỗ trợ pluralization nâng cao.

> Mẹo: Nếu dùng pipe translate tự viết, hãy tạo unit test cho các trường hợp thiếu key, thay placeholder và chuyển locale để đảm bảo không phát sinh lỗi khi mở rộng thêm ngôn ngữ khác.
