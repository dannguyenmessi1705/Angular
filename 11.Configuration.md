# Cấu hình môi trường & đa ngôn ngữ khi triển khai

Tài liệu này giúp bạn (hoặc học viên mới) thiết lập máy phát triển Angular đúng chuẩn và triển khai ứng dụng với nhiều ngôn ngữ. Các bước được trình bày theo thứ tự nên thực hiện mỗi khi khởi tạo dự án mới.

## 1. Chuẩn bị môi trường phát triển
- **Node.js & quản lý phiên bản**
  1. Cài [nvm](https://github.com/nvm-sh/nvm) (Linux/macOS) hoặc [nvm-windows](https://github.com/coreybutler/nvm-windows).
  2. Kiểm tra cài đặt: `command -v nvm`.
  3. Cài Node LTS: 
  ```bash
  nvm install 20
  nvm use 20
  node -v
  ```
  4. Nếu dùng Windows hãy kích hoạt WSL2 + Ubuntu để tránh các vấn đề về quyền truy cập file khi chạy `ng serve`.
- **Angular CLI**
  - Cài toàn cục: `npm install -g @angular/cli`.
  - Hoặc cài theo dự án: `npm install -D @angular/cli` rồi chạy `npx ng`.
  - Xác nhận phiên bản: `ng version` (CLI) và `npm ls @angular/core` (package runtime). Hai số phiên bản nên khớp nhau.
- **Package manager**
  - Chuẩn hoá bằng [Corepack](https://nodejs.org/api/corepack.html) để không phải cài riêng từng công cụ.
  ```bash
  corepack enable
  corepack prepare pnpm@latest --activate
  pnpm install
  ```
  - Commit file lock (`package-lock.json`, `pnpm-lock.yaml`) vào repo để mọi môi trường cài đặt giống nhau.
- **IDE & tiện ích**
  - Cài VS Code + Angular Language Service, ESLint, Prettier, GitLens, EditorConfig.
  - Bật `Format On Save`, `Organize Imports on Save` và `eslint.validate` trong `settings.json`.
  - Tạo `.vscode/extensions.json` gợi ý plugin cho đồng đội.
- **Kiểm tra hệ thống**
  - `ng doctor` để xác nhận CLI/Node tương thích.
  - `npm audit` hoặc `pnpm audit` để xem các cảnh báo bảo mật.
  - Với Linux, cài `build-essential python3` vì một số dependency Angular cần biên dịch native module.
  - Tạo file `README_ENV.md` trong dự án ghi rõ các công cụ đã cài và phiên bản đề xuất.

## 2. Thiết lập workspace Angular
1. Tạo workspace: `ng new angular-starter --ssr --routing --style=scss --strict`. Nếu đã có workspace, dùng `ng g application dashboard --routing --standalone` để tạo ứng dụng con.
2. Bật các tùy chọn hữu ích trong `angular.json`:
```json
"build": {
  "configurations": {
    "production": {
      "budgets": [
        { "type": "initial", "maximumWarning": "750kb", "maximumError": "1mb" }
      ],
      "outputHashing": "all"
    },
    "staging": {
      "optimization": true,
      "sourceMap": true,
      "fileReplacements": [
        {
          "replace": "src/environments/environment.ts",
          "with": "src/environments/environment.staging.ts"
        }
      ]
    }
  }
}
```
3. Thiết lập `tsconfig.json` chung với các option: `strict`, `noImplicitOverride`, `useDefineForClassFields`, `forceConsistentCasingInFileNames` và alias `paths` (ví dụ `"@app/*": ["src/app/*"]`, `"@env/*": ["src/environments/*"]`) để import gọn hơn.
4. Thêm script vào `package.json`:
```json
"scripts": {
  "start": "ng serve",
  "start:hmr": "ng serve --hmr",
  "start:mock": "ng serve --proxy-config proxy.conf.json",
  "lint": "ng lint",
  "lint:fix": "ng lint --fix",
  "test": "ng test --watch=false",
  "test:watch": "ng test",
  "format": "prettier --write \"src/**/*.{ts,html,scss}\""
}
```
5. Bật Husky/lefthook để chạy `lint` + `test` nhẹ trước khi commit. Điều này đặc biệt cần thiết khi tài liệu được cập nhật bởi nhiều người.
6. Với dự án SSR hoặc cần fetch API, cấu hình `server.ts` (khi dùng Angular Universal) hoặc `proxy.conf.json` (xem mục 3) để tránh lỗi CORS và mô phỏng backend nội bộ.

## 3. Biến môi trường và proxy backend
### 3.1. Tổ chức biến môi trường
- Angular tạo sẵn `src/environments/environment.ts` (dev) và `environment.prod.ts`. Bạn nên tạo thêm `environment.staging.ts`, `environment.qa.ts` nếu cần.
- Ví dụ nội dung file:
```ts
export const environment = {
  production: false,
  apiBaseUrl: 'http://localhost:3000',
  featureFlags: {
    enableNewSidebar: true,
  },
};
```
- `angular.json` điều khiển file nào được thay thế ở từng cấu hình:
```json
"configurations": {
  "production": {
    "fileReplacements": [
      {
        "replace": "src/environments/environment.ts",
        "with": "src/environments/environment.prod.ts"
      }
    ]
  },
  "staging": {
    "fileReplacements": [
      {
        "replace": "src/environments/environment.ts",
        "with": "src/environments/environment.staging.ts"
      }
    ]
  }
}
```
- Secrets (API key, token) **không** nên ghi thẳng vào file environment. Thay vào đó:
  1. Định nghĩa placeholder trong environment (`apiKey: ''`).
  2. Truyền giá trị thật thông qua biến môi trường runtime hoặc server-side (ví dụ đặt trong backend và trả về khi người dùng login).
  3. Nếu vẫn cần inject lúc build, dùng gói [ngx-env](https://www.npmjs.com/package/@ngx-env/builder) hoặc script shell để thay thế giá trị trước khi chạy `ng build`.

### 3.2. Proxy backend trong môi trường dev
- Proxy giúp chuyển `http://localhost:4200/api/...` tới API thực mà không vi phạm CORS. Tạo `proxy.conf.json` tại gốc project:
```json
{
  "/api": {
    "target": "http://localhost:3333",
    "secure": false,
    "changeOrigin": true,
    "logLevel": "debug",
    "pathRewrite": {
      "^/api": ""
    }
  },
  "/auth": {
    "target": "https://dev-auth.example.com",
    "secure": true,
    "changeOrigin": true
  }
}
```
- Chạy dev server: `ng serve --proxy-config proxy.conf.json`.
- Ý nghĩa các thuộc tính:
  - `target`: địa chỉ backend thật.
  - `secure`: đặt `false` nếu backend dùng HTTPS tự ký trong lúc dev.
  - `changeOrigin`: sửa header `Host` cho phù hợp backend.
  - `pathRewrite`: xoá/bổ sung prefix.
  - Có thể khai báo nhiều entry để proxy tới các service khác nhau (`/auth`, `/files`…).
- Khi deploy production, proxy thường do web server (Nginx, CloudFront) đảm nhận. Đảm bảo bạn đã cấu hình CORS ở backend hoặc CDN tương ứng.

### 3.3. Cấu hình runtime qua APP_INITIALIZER
- **Runtime config**: nếu muốn thay đổi cấu hình sau khi build, tạo file `src/assets/config.json` và tải ở `main.ts` bằng `APP_INITIALIZER`.
```ts
export interface AppRuntimeConfig { apiBaseUrl: string; version: string; }
export const APP_RUNTIME_CONFIG = new InjectionToken<AppRuntimeConfig>('app-runtime-config');

export function initAppConfig(http: HttpClient) {
  return () => http.get<AppRuntimeConfig>('/assets/config.json').pipe(tap(cfg => runtimeConfig = cfg));
}
```
Sau đó cung cấp: `providers: [{ provide: APP_RUNTIME_CONFIG, useFactory: () => runtimeConfig }]`. Bằng cách này bạn có thể triển khai một bundle duy nhất cho dev/staging/prod và chỉ thay file JSON.
- **Bảo mật**: không đưa secret vào bundle (kể cả môi trường prod). Sử dụng secret manager của nền tảng hosting (Firebase, Vercel, Azure) và chỉ truyền token tạm thời qua API backend.

## 4. Pipeline build & kiểm tra
- `ng lint`, `ng test`, `ng e2e` nên được thêm vào CI. Sử dụng GitHub Actions đơn giản:
```yaml
steps:
  - uses: actions/checkout@v4
  - uses: actions/setup-node@v4
    with:
      node-version: 20
      cache: npm
  - run: npm ci
  - run: npm run lint && npm run test -- --watch=false
  - run: npm run build -- --configuration=production
```
- Đối với deploy SSR, sử dụng `ng build && ng run project:server:production` rồi `node dist/project/server/main.js`. Các dịch vụ như Firebase Hosting, Vercel có template sẵn cho Angular SSR.
- **Cache phụ thuộc**: dùng `actions/cache` để lưu `~/.npm` hoặc `~/.pnpm-store`. Ví dụ:
```yaml
  - uses: actions/cache@v4
    with:
      path: ~/.npm
      key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
```
- **Artifacts/Container**: build Docker multi-stage để triển khai static bundle:
```dockerfile
FROM node:20-alpine as build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build -- --configuration=production

FROM nginx:alpine
COPY nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=build /app/dist/angular-starter/browser /usr/share/nginx/html
```
- **Giám sát chất lượng**: tích hợp SonarCloud hoặc CodeQL vào pipeline để quét bảo mật, kèm badge CI trong README để học viên dễ theo dõi.

## 5. Thiết lập i18n bằng Angular Localize
1. Cài gói: `ng add @angular/localize`.
2. Thêm thuộc tính i18n vào template: `<h1 i18n="@@homeTitle">Xin chào</h1>`.
3. Trích xuất bản dịch: `ng extract-i18n --output-path src/locale`. Mặc định tạo file `messages.xlf`.
4. Tạo bản dịch theo từng ngôn ngữ, ví dụ `messages.vi.xlf`, `messages.en.xlf`.
5. Cập nhật `angular.json`:
```json
"i18n": {
  "sourceLocale": "vi",
  "locales": {
    "en": {
      "translation": "src/locale/messages.en.xlf"
    }
  }
},
"build": {
  "configurations": {
    "production-en": {
      "localize": ["en"],
      "outputPath": "dist/app/en"
    },
    "production-vi": {
      "localize": ["vi"],
      "outputPath": "dist/app/vi"
    }
  }
}
```
6. Build đa ngôn ngữ: `ng build --configuration production-vi,production-en`. Angular sẽ tạo thư mục riêng cho mỗi locale, tự động thay thế chuỗi và thẻ `html lang`.
7. Triển khai: cấu hình server để chuyển hướng `/en/*` tới thư mục `dist/app/en`, `/vi/*` tới `dist/app/vi`. Với Nginx có thể dùng `try_files $uri $uri/ /en/index.html`.
- **Quản lý file dịch**:
  - Dùng `@@customId` để giữ khóa ổn định giữa các lần `ng extract-i18n`.
  - Quy ước mô tả `i18n="@@loginTitle|Tiêu đề trang đăng nhập"` giúp người dịch hiểu ngữ cảnh.
  - Với dự án lớn, chia nhỏ file `messages` theo module rồi gộp lại bằng `xliffmerge`.
- **Locale data**: đăng ký trong `main.ts`:
```ts
import localeVi from '@angular/common/locales/vi';
registerLocaleData(localeVi);
provideLocale('vi');
```
- **Ví dụ thực tế**: Nếu muốn xem ví dụ nhỏ với hai ngôn ngữ và pipe dịch runtime, tham khảo thêm `12.i18n Pipes Example.md`.

## 6. Đổi ngôn ngữ runtime
- Built-in i18n hoạt động ở compile-time. Nếu cần đổi ngôn ngữ khi ứng dụng đang chạy (ví dụ dropdown chọn ngôn ngữ), hãy dùng thư viện như [Transloco](https://ngneat.github.io/transloco/) hoặc `@ngx-translate/core`.
- Quy trình với Transloco:
  1. `ng add @ngneat/transloco`.
  2. Thêm file `src/assets/i18n/en.json`, `vi.json`.
  3. Inject `TranslocoService` và gọi `setActiveLang('en')`.
  4. Sử dụng pipe: `{{ 'home.title' | transloco }}`.
- Khi triển khai SSR + Transloco, bật `provideTranslocoMessageFormat()` và preload file JSON trên server để tránh nhấp nháy.
- **Cấu trúc thư mục đề xuất**:
```
src/assets/i18n/
  en/
    common.json
    home.json
  vi/
    common.json
    home.json
```
- **Lazy load bản dịch**: sử dụng `TranslocoHttpLoader` cho từng feature module, giúp bundle ban đầu nhẹ hơn.
- **Fallback**: thiết lập `fallbackLang: 'en'` hoặc `setFallbackLangForMissingTranslation`.

## 7. Đồng bộ router với đa ngôn ngữ
- Bạn có thể dùng prefix route (`/vi/...`, `/en/...`) hoặc subdomain (`vi.example.com`). Nếu dùng prefix, tạo guard `LanguageGuard` để xác thực locale hợp lệ rồi chuyển hướng sang `/vi`.
- Khi kết hợp Angular Router và i18n:
  - Thêm `data: { i18nTitle: 'home.title' }` cho từng route, sau đó dùng Transloco hoặc `TitleStrategy` để cập nhật tiêu đề bằng ngôn ngữ hiện tại.
  - Nếu dùng Angular built-in i18n (compile-time), build mỗi locale rồi cấu hình rewrite trên CDN.
  - Với runtime i18n, bật `initialNavigation: 'enabledBlocking'` để server trả đúng ngôn ngữ dựa trên header `Accept-Language`.
- **Map locale**: tạo util ánh xạ `vi` ↔ `vi-VN`, `en` ↔ `en-US` để đồng bộ với API/back-end. Ví dụ `resolveLocale("vi")` trả về object chứa `localeId`, `dateFnsLocale`.
- **Thay đổi ngôn ngữ bằng URL**: subscribe `Router.events` (lọc `NavigationEnd`) và mỗi khi prefix `/en`/`/vi` thay đổi hãy gọi `translocoService.setActiveLang`.

## 8. Checklist trước khi triển khai đa ngôn ngữ
- [ ] Chuỗi giao diện đã được đánh dấu `i18n` hoặc thêm key trong Transloco/ngx-translate.
- [ ] Định dạng ngày/tiền tệ dựa trên `LOCALE_ID` (`provideLocale('vi')`, `registerLocaleData`).
- [ ] Router đã xử lý locale (prefix, subdomain hoặc guard).
- [ ] Nội dung SEO (title, meta) hỗ trợ từng ngôn ngữ.
- [ ] Pipeline CI/CD build đúng số lượng bản locale cần deploy.
- [ ] Kiểm tra thủ công: thay đổi ngôn ngữ, reload trang, truy cập trực tiếp đường link sâu (`/en/products/123`).
- [ ] Server trả header `Content-Language` chính xác và có file sitemap riêng cho từng locale.
- [ ] Tài liệu/README cập nhật danh sách locale hỗ trợ, cách đóng góp bản dịch, người phụ trách duyệt nội dung.

## 9. Phụ lục: Công cụ & mẹo vận hành
- **Theo dõi kích thước bundle**: `ng build --stats-json` + `npx ngx-build-plus --analyze` hoặc `source-map-explorer dist/app/browser/*.js`.
- **Kiểm thử accessibility đa ngôn ngữ**: dùng Lighthouse hoặc axe-core để đảm bảo văn bản dịch vẫn đáp ứng WCAG (độ tương phản, aria-label).
- **Kết nối đội dịch thuật**: upload file `.xlf` hoặc `.json` lên Crowdin, Lokalise. Sau khi tải về chạy script kiểm tra khóa thiếu (`npm run i18n:lint` tự định nghĩa).
- **Quản lý thời gian**: nếu backend trả về dữ liệu timezone khác, dùng `Intl.DateTimeFormat(locale, options)` để hiển thị đúng locale thay vì tự format thủ công.
- **Giám sát runtime**: khi deploy PWA đa ngôn ngữ, bật logging (Sentry, Application Insights) và gắn tag `locale` để phân tích lỗi theo từng bản dịch.

> Ghi chú: hãy cập nhật file này mỗi khi team thay đổi cách cấu hình (ví dụ chuyển từ Angular i18n sang Transloco) để tất cả tài liệu hướng dẫn khác trong repo vẫn chính xác.
