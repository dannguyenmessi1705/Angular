# Pipes
## 1. Giới thiệu
Pipes trong Angular là một cách để biến đổi dữ liệu trong template. Chúng cho phép bạn định dạng, lọc và xử lý dữ liệu một cách dễ dàng mà không cần phải thay đổi mã nguồn của component.

## 2. Các loại Pipes
- `DatePipe`: Định dạng ngày tháng.
- `UpperCasePipe`: Chuyển đổi chuỗi thành chữ hoa.
- `LowerCasePipe`: Chuyển đổi chuỗi thành chữ thường.
- `CurrencyPipe`: Định dạng tiền tệ.
- `DecimalPipe`: Định dạng số thập phân.
- `PercentPipe`: Định dạng phần trăm.
- `AsyncPipe`: Được sử dụng để xử lý các Observable hoặc Promise trong template.
- `JsonPipe`: Chuyển đổi đối tượng thành chuỗi JSON.
- `TitleCasePipe`: Chuyển đổi chuỗi thành chữ hoa ở đầu mỗi từ.
- `SlicePipe`: Cắt một mảng hoặc chuỗi thành một phần.
- `KeyValuePipe`: Chuyển đổi một đối tượng thành mảng các cặp key-value.
- `I18nSelectPipe`: Được sử dụng để chọn một giá trị từ một tập hợp các giá trị dựa trên ngôn ngữ hiện tại.
- `I18nPluralPipe`: Được sử dụng để xử lý các dạng số nhiều trong ngôn ngữ.

> Chi tiết xem tại: [Angular Pipes](https://angular.dev/guide/templates/pipes)

## 3. Cách sử dụng Pipes

Để sử dụng Pipes trong Angular, bạn chỉ cần thêm ký hiệu `|` vào template của component. Ngoài ra, trong component, cần import các pipe tương ứng từ `@angular/common`. 
> Sử dụng tùy chọn của pipes với cú pháp `pipeName: 'option1':'option2'`
Ví dụ:

```html
<p>{{ today | date }}</p>
<p>{{ message | uppercase }}</p>
<p>{{ amount | currency }}</p>
<p>{{ pi | number: '1.2-2' }}</p>
<p>{{ progress | percent }}</p>
<p>{{ asyncData | json }}</p>
```

Trong ví dụ trên:
- `date` pipe sẽ định dạng ngày tháng.
- `uppercase` pipe sẽ chuyển đổi chuỗi thành chữ hoa.
- `currency` pipe sẽ định dạng số thành tiền tệ.
- `number` pipe sẽ định dạng số thập phân.
- `percent` pipe sẽ định dạng số thành phần trăm.
- `json` pipe sẽ chuyển đổi đối tượng thành chuỗi JSON.

## 4. Tạo Pipes tùy chỉnh
Bạn cũng có thể tạo các pipes tùy chỉnh trong Angular bằng cách sử dụng cú pháp sau:

```bash
ng generate pipe pipe-name
```

> Ví dụ 1: tạo pipes chuyển đổi thang nhiệt độ
```ts
import { Pipe, PipeTransform } from "@angular/core";

@Pipe({
  name: "temperature", // Tên pipe
  standalone: true,
})
export class TemperaturePipe implements PipeTransform { // kế thừa PipeTransform
  /**
   *
   * @param value: giá trị mà bạn muốn chuyển đổi
   * @param args: cấu hình các tùy chọn (Celsius, Fahrenheit)
   * @returns: số nhiệt độ đã chuyển đổi
   * @example: {{ 100 | temperature: 'Celsius' }}
   */
  transform(
    value: string | number, // Giá trị nhiệt độ
    inputType: "C" | "F", // Kiểu đầu vào (Celsius hoặc Fahrenheit)
    outputType: "C" | "F" // Kiểu đầu ra (Celsius hoặc Fahrenheit)
  ): string {
    let temp: number;
    if (typeof value === "string") {
      temp = parseFloat(value);
    } else {
      temp = value;
    }

    let symbol: string;
    let result: number;

    if (inputType === "C" && outputType === "F") {
      result = (temp * 9) / 5 + 32;
    } else if (inputType === "F" && outputType === "C") {
      result = ((temp - 32) * 5) / 9;
    } else {
      result = temp;
    }

    if (!outputType) {
      symbol = inputType === "C" ? "C" : "F";
    } else {
      symbol = outputType === "C" ? "C" : "F";
    }
    return `${temp}°${symbol}`;
  }
}
```
```html
<p>{{ 100 | temperature: 'C':'F' }}</p>
```

## 5. Lưu ý
> Chú ý, nơi đặt pipe phải có giá trị đầu vào và đầu ra tương ứng. Ví dụ pipes sort sẽ đặt trong vòng lặp
```html
@for (temperature of temperatures | sort: "desc"; track temperature) {
    <li>{{ temperature | temperature: 'C':'F' }}</li>
}
```

> Có thể dùng nested pipes để xử lý dữ liệu phức tạp hơn.
```html
<p>{{ (100 | temperature: 'C':'F') | currency }}</p>
```

> Sử dụng `pure` pipe để tối ưu hiệu suất cho các pipe tùy chỉnh. (Được cấu hình trong `pipes.ts`). Nếu `pure = false`, pipe sẽ được gọi lại mỗi khi có sự thay đổi trong template. Ngược lại, nếu `pure = true`, pipe chỉ được gọi lại khi có sự thay đổi trong giá trị đầu vào, do đã lưu trong bộ nhớ cache.
```ts
import { Pipe, PipeTransform } from "@angular/core";

@Pipe({
  name: "temperature",
  pure: true,
})
export class TemperaturePipe implements PipeTransform {
  transform(
    value: string | number,
    inputType: "C" | "F",
    outputType: "C" | "F"
  ): string {
    // Logic chuyển đổi nhiệt độ
  }
}
```

> Hạn chế của Pipes, khi nào nên đùng: Pipes có thể làm giảm hiệu suất nếu không được sử dụng đúng cách, đặc biệt là với các dữ liệu lớn hoặc phức tạp. Nên tránh sử dụng pipes trong các vòng lặp hoặc các tình huống mà dữ liệu có thể thay đổi thường xuyên.

## 6. Phân biệt `pure` và `impure` pipe
- **Pure pipe (mặc định)**: Chỉ chạy lại khi Angular so sánh thấy đầu vào mới (primitive thay đổi hoặc tham chiếu object khác). Phù hợp cho mọi pipe định dạng dữ liệu, calc… giúp hiệu năng cao.
- **Impure pipe**: Chạy lại ở mỗi vòng change detection. Chỉ sử dụng khi bạn **thật sự** cần đọc giá trị thay đổi nhưng tham chiếu giống nhau (ví dụ pipe lọc trực tiếp từ `Map` hoặc `Set`). Đừng dùng impure để cập nhật dữ liệu từ server – hãy chuyển logic sang service hoặc `computed`.
- Khi ví dụ cần biến đổi phức tạp, hãy cân nhắc chuyển sang `standalone` function và gọi trong component thay vì pipe. Tài liệu của bạn nên giải thích rõ lý do để người mới không biến pipe thành nơi chứa business logic.

## 7. Async pipe và Signals
- `AsyncPipe` vừa subscribe vừa unsubscribe giúp template gọn hơn. Nó hỗ trợ `Observable`, `Signal`, `Subscribable` và `Promise`. Khi kết hợp với Signals bạn không cần viết converter thủ công.
```ts
@Component({
  selector: 'app-dashboard',
  standalone: true,
  template: `
    <h3>Nhiệt độ hiện tại</h3>
    <p>{{ currentWeather$ | async | json }}</p>
  `,
  imports: [AsyncPipe],
})
export class DashboardComponent {
  private readonly http = inject(HttpClient);
  readonly currentWeather$ = this.http.get('/api/weather'); // Async pipe sẽ tự hủy khi component destroy
}
```
- Với signals: `{{ weatherSignal() | json }}` là đủ, tuy nhiên nếu service của bạn vẫn trả về Observable hãy chuyển đổi bằng `toSignal` hoặc dùng luôn `async` pipe thay vì subscribe thủ công trong component.

## 8. Kiểm thử pipe
- Angular CLI tạo sẵn spec cho pipe. Một bài test cơ bản nên xác nhận:
  1. Pipe được khởi tạo (`expect(pipe).toBeTruthy()`).
  2. Trả về giá trị mong muốn với nhiều bộ dữ liệu khác nhau.
  3. Với pipe bất đồng bộ hoặc pipe có dependency (inject service), hãy khai báo `TestBed` và cung cấp mock service.
```ts
describe('TemperaturePipe', () => {
  const pipe = new TemperaturePipe();

  it('chuyển C sang F', () => {
    expect(pipe.transform(0, 'C', 'F')).toBe('32°F');
  });

  it('không đổi đơn vị', () => {
    expect(pipe.transform(32, 'F', 'F')).toBe('32°F');
  });
});
```
- Nếu pipe đọc dữ liệu từ HTTP hoặc store, hãy đặt logic đó trong service. Pipe chỉ nên gọi method đã được mock trong test. Điều này giúp tài liệu hướng dẫn tập trung vào kiến thức cốt lõi thay vì debug phụ thuộc ngoài lề.
